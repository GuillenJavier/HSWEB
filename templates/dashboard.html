{% extends "_layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

{% if current_user.tipo == 'MEDICO' %}
  <section class="card">
    {% if saludo and doctor_nombre %}
      <h2 class="center">{{ saludo }}, {{ doctor_nombre }}.</h2>
    {% else %}
      <h2 class="center">Bienvenido(a) doctor(a).</h2>
    {% endif %}

    <!-- Botones centrados -->
    <div class="action-bar">
      <a class="btn btn-primary" href="{{ url_for('doctor_consultas') }}">Mis citas pendientes</a>
      <a class="btn btn-ghost" href="{{ url_for('doctor_concluidas') }}">Citas concluidas</a>
      <a class="btn btn-secondary" href="{{ url_for('doctor_expedientes') }}">Expedientes de mis pacientes</a>
    </div>
  </section>

  <section class="card" style="margin-top: 1rem;">
    <h3>Pacientes atendidos</h3>
    {% if pacientes|length == 0 %}
      <p class="center">Aún no tienes pacientes registrados por citas.</p>
    {% else %}
      <ul>
        {% for p in pacientes %}
          {% set pendientes = pending_counts.get(p.id, 0) %}
          <li style="display:flex; align-items:center; justify-content:space-between; gap:.5rem; flex-wrap:wrap; padding:.35rem 0;">
            <div>
              <strong>{{ p.nombre }} {{ p.apellido }}</strong>
              <small style="opacity:.7;"> · {% if pendientes > 0 %}{{ pendientes }} pendiente(s){% else %}Sin pendientes{% endif %}</small>
            </div>
            <div class="action-bar" style="margin:0;">
              <a class="btn btn-ghost" href="{{ url_for('doctor_consultas', paciente_id=p.id) }}">Ver citas</a>
              <a class="btn btn-primary" href="{{ url_for('expediente_view', paciente_id=p.id) }}">Ver expediente</a>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </section>

{% else %}
  <!-- Vista para paciente/admin -->
  <section class="card">
    <h2 class="center">Dashboard</h2>
    <p class="center">Bienvenido, {{ current_user.nombre }} {{ current_user.apellido }} ({{ current_user.tipo }})</p>

    <div class="action-bar">
      <a class="btn btn-primary" href="{{ url_for('citas_new') }}">Agendar nueva cita</a>
      <a class="btn btn-ghost" href="{{ url_for('citas_list') }}">Ver mis citas</a>
    </div>
  </section>

  <section class="card" style="margin-top:1rem;">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Médico</th>
          <th>Paciente</th>
          <th>Inicio</th>
          <th>Fin</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for c in citas %}
        <tr>
          <td>{{ c.id }}</td>
          <td>{{ c.medico.usuario.nombre }} {{ c.medico.usuario.apellido }} ({{ c.medico.especialidad }})</td>
          <td>{{ c.paciente.nombre }} {{ c.paciente.apellido }}</td>
          <td>{{ c.start_at }}</td>
          <td>{{ c.end_at }}</td>
          <td>{{ c.estado }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endif %}

{% endblock %}
